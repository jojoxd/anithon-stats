{"version":3,"sources":["../../../../../libs-anilist.old/anilist/src/lib/ApolloClientBuilder.ts"],"sourcesContent":["\"use strict\";\n\nimport {ApolloClient, InMemoryCache, ApolloLink, HttpLink, Operation, NextLink} from \"apollo-boost\";\nimport {ApolloCache} from \"apollo-cache\";\nimport fetch from \"node-fetch\";\nimport {$log} from \"@tsed/common\";\n\nexport class ApolloClientBuilder\n{\n    protected cache: ApolloCache<any> | null = null;\n    protected link: ApolloLink | null = null;\n    protected authLink: ApolloLink | null = null;\n\n    constructor(uri?: string, cache?: any) {\n        if (typeof uri !== \"undefined\")\n            this.withUri(uri);\n\n        if (typeof cache !== \"undefined\")\n            this.withCache(cache);\n    }\n\n    withCache<TCache>(cache: ApolloCache<TCache>): this {\n        this.cache = cache;\n\n        return this;\n    }\n\n    withMemoryCache(): this {\n        this.withCache(new InMemoryCache());\n\n        return this;\n    }\n\n    withUri(uri: string): this {\n        this.link = new HttpLink({\n            uri,\n\n            // @ts-ignore TS-2322 Different implementations, but are compatible\n            fetch\n        });\n\n        return this;\n    }\n\n    withAuth(getBearer: () => string | null)\n    {\n        this.authLink = new ApolloLink((operation: Operation, forward: NextLink): any => {\n            const bearerToken = getBearer();\n\n            if(bearerToken !== null) {\n                operation.setContext({\n                    headers: {\n                        Authorization: `Bearer ${getBearer()}`\n                    }\n                });\n            }\n\n            return forward(operation);\n        });\n    }\n\n    protected get interceptorLink(): ApolloLink\n    {\n        return new ApolloLink((operation: Operation, forward: NextLink): any => {\n\n            // Before\n            $log.info(`GQL REQUEST \"${operation.operationName}\"`);\n\n            const response = forward(operation);\n\n            // After\n\t\t\t$log.info(`GQL REQUEST COMPLETE \"${operation.operationName}\"`);\n\n            return response;\n        });\n    }\n\n    build(): ApolloClient<any> | never {\n        if (this.link === null)\n            throw new Error(\"No Link Specified\");\n\n        if (this.cache === null)\n            this.withMemoryCache();\n\n        let link: ApolloLink = this.interceptorLink.concat(this.link);\n\n        if(this.authLink) {\n            link = this.authLink.concat(this.link);\n        }\n\n        return new ApolloClient({\n            cache: this.cache!,\n            link,\n        });\n    }\n}\n"],"names":["ApolloClientBuilder","uri","cache","link","authLink","withUri","withCache","withMemoryCache","InMemoryCache","HttpLink","fetch","withAuth","getBearer","ApolloLink","operation","forward","bearerToken","setContext","headers","Authorization","build","Error","interceptorLink","concat","ApolloClient","$log","info","operationName","response"],"mappings":"AAAA;;;;+BAOaA;;;eAAAA;;;2BALwE;gDAEnE;sBACC;;;;;;;;;;;;;;;;;;;;;;;;;AAEZ,IAAA,AAAMA,oCAPV,AAOI;aAAMA,oBAMGC,GAAY,EAAEC,KAAW;8BAN5BF;aAECE,QAAiC,IAAI;aACrCC,OAA0B,IAAI;aAC9BC,WAA8B,IAAI;QAGxC,IAAI,OAAOH,QAAQ,aACf,IAAI,CAACI,OAAO,CAACJ;QAEjB,IAAI,OAAOC,UAAU,aACjB,IAAI,CAACI,SAAS,CAACJ;;iBAXdF;IAcTM,OAAAA,SAIC,GAJDA,SAAAA,UAAkBJ,KAA0B,EAAQ;QAChD,IAAI,CAACA,KAAK,GAAGA;QAEb,OAAO,IAAI;IACf;IAEAK,OAAAA,eAIC,GAJDA,SAAAA,kBAAwB;QACpB,IAAI,CAACD,SAAS,CAAC,IAAIE,0BAAa;QAEhC,OAAO,IAAI;IACf;IAEAH,OAAAA,OASC,GATDA,SAAAA,QAAQJ,GAAW,EAAQ;QACvB,IAAI,CAACE,IAAI,GAAG,IAAIM,qBAAQ,CAAC;YACrBR,KAAAA;YAEA,mEAAmE;YACnES,OAAAA,kBAAK;QACT;QAEA,OAAO,IAAI;IACf;IAEAC,OAAAA,QAeC,GAfDA,SAAAA,SAASC,SAA8B,EACvC;QACI,IAAI,CAACR,QAAQ,GAAG,IAAIS,uBAAU,CAAC,SAACC,WAAsBC,SAA2B;YAC7E,IAAMC,cAAcJ;YAEpB,IAAGI,gBAAgB,IAAI,EAAE;gBACrBF,UAAUG,UAAU,CAAC;oBACjBC,SAAS;wBACLC,eAAe,AAAC,UAAqB,OAAZP;oBAC7B;gBACJ;YACJ,CAAC;YAED,OAAOG,QAAQD;QACnB;IACJ;IAkBAM,OAAAA,KAiBC,GAjBDA,SAAAA,QAAmC;QAC/B,IAAI,IAAI,CAACjB,IAAI,KAAK,IAAI,EAClB,MAAM,IAAIkB,MAAM,qBAAqB;QAEzC,IAAI,IAAI,CAACnB,KAAK,KAAK,IAAI,EACnB,IAAI,CAACK,eAAe;QAExB,IAAIJ,OAAmB,IAAI,CAACmB,eAAe,CAACC,MAAM,CAAC,IAAI,CAACpB,IAAI;QAE5D,IAAG,IAAI,CAACC,QAAQ,EAAE;YACdD,OAAO,IAAI,CAACC,QAAQ,CAACmB,MAAM,CAAC,IAAI,CAACpB,IAAI;QACzC,CAAC;QAED,OAAO,IAAIqB,yBAAY,CAAC;YACpBtB,OAAO,IAAI,CAACA,KAAK;YACjBC,MAAAA;QACJ;IACJ;iBAvFSH;;YAsDKsB,KAAAA;iBAAd,eACA;gBACI,OAAO,IAAIT,uBAAU,CAAC,SAACC,WAAsBC,SAA2B;oBAEpE,SAAS;oBACTU,eAAI,CAACC,IAAI,CAAC,AAAC,gBAAuC,OAAxBZ,UAAUa,aAAa,EAAC;oBAElD,IAAMC,WAAWb,QAAQD;oBAEzB,QAAQ;oBACjBW,eAAI,CAACC,IAAI,CAAC,AAAC,yBAAgD,OAAxBZ,UAAUa,aAAa,EAAC;oBAElD,OAAOC;gBACX;YACJ;;;WApES5B"}